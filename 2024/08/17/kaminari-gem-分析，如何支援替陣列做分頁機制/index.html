<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="theme-color" content="#600090"><meta name="msapplication-navbutton-color" content="#600090"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#600090"><meta property="og:image" content="https://khiav223577.github.io/blog/imgs/wolf.jpg"><meta property="og:image" content="/blog/imgs/forest_wolf.png"><meta name="description" content="介紹一般我們使用 kaminari 時，是為了想要替 ActiveRecord 做分頁，以避免一次性讀取所有資料。但有時候資料來源並非來自資料庫，例如當我們想顯示一個大型的 CSV 檔案時，行數過多需要分頁來優化顯示。此時我們會需要對一個陣列進行分頁。 其實，Kaminari 已經提供了一個 paginate_array 的 class method，讓我們可以對陣列進行分頁。這個方法會將陣列加上"><meta property="og:type" content="article"><meta property="og:title" content="kaminari gem 分析，如何支援替陣列做分頁機制｜像哈士奇的狼"><meta property="og:url" content="https://khiav223577.github.io/blog/2024/08/17/kaminari-gem-%E5%88%86%E6%9E%90%EF%BC%8C%E5%A6%82%E4%BD%95%E6%94%AF%E6%8F%B4%E6%9B%BF%E9%99%A3%E5%88%97%E5%81%9A%E5%88%86%E9%A0%81%E6%A9%9F%E5%88%B6/index.html"><meta property="og:site_name" content="狼"><meta property="og:description" content="介紹一般我們使用 kaminari 時，是為了想要替 ActiveRecord 做分頁，以避免一次性讀取所有資料。但有時候資料來源並非來自資料庫，例如當我們想顯示一個大型的 CSV 檔案時，行數過多需要分頁來優化顯示。此時我們會需要對一個陣列進行分頁。 其實，Kaminari 已經提供了一個 paginate_array 的 class method，讓我們可以對陣列進行分頁。這個方法會將陣列加上"><meta property="og:locale"><meta property="article:published_time" content="2024-08-17T08:18:51.000Z"><meta property="article:modified_time" content="2024-08-17T11:13:48.526Z"><meta property="article:author" content="狼"><meta property="article:tag" content="Rails"><meta property="article:tag" content="Ruby"><meta property="article:tag" content="pagination"><meta name="twitter:card" content="summary"><meta property="fb:app_id" content="172563456645359"><link rel="shortcut icon" href="/blog/imgs/wolf.ico"><link rel="alternate" type="application/atom+xml" title="狼" href="/atom.xml"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css"><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.min.css"><title>kaminari gem 分析，如何支援替陣列做分頁機制｜像哈士奇的狼</title><link rel="canonical" href="https://khiav223577.github.io/blog/2024/08/17/kaminari-gem-分析，如何支援替陣列做分頁機制/"><link rel="stylesheet" href="/blog/css/bootstrap.min.css"><link rel="stylesheet" href="/blog/css/blog-style.css"><script async src="/blog/js/algolia.js"></script><script async src="/blog/js/instantsearch.min.js"></script><meta name="generator" content="Hexo 6.3.0"></head><style>header.intro-header{background-image:url(/blog/imgs/water-blue.jpg)}</style><body ontouchstart="" class="animated fadeIn"><nav class="navbar navbar-default navbar-custom navbar-fixed-top" id="nav-top" data-ispost="true" data-istags="false" data-ishome="false" data-isarchive="false"><div class="container-fluid"><div class="navbar-header page-scroll"><button type="button" class="navbar-toggle"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand animated pulse" href="/blog/">像哈士奇的<span class="brand-logo"> 狼</span></a></div><div id="huxblog_navbar"><div class="navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/blog/">Home</a></li><li><a href="/blog/archive/">Archive</a></li><li><a href="/blog/tags/">Tags</a></li><li><a href="/blog/categories/">categories</a></li><li><a href="#search" class="popup-trigger"><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");function handleMagic(e){0<$navbar.className.indexOf("in")?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}$toggle.addEventListener("click",handleMagic)</script><div class="site-search"><div class="algolia-popup popup"><div class="algolia-search"><div class="algolia-search-input-icon"><i class="fa fa-search"></i></div><div class="algolia-search-input" id="algolia-search-input"></div></div><div class="algolia-results"><div id="algolia-stats"></div><div id="algolia-hits"></div><div id="algolia-pagination" class="algolia-pagination"></div></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div></div><img class="wechat-title-img" src="/blog/imgs/forest_wolf.png"><style>header.intro-header{background-image:url(/blog/imgs/forest_wolf.png)}</style><header class="intro-header"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center"><div class="post-heading"><h1>kaminari gem 分析，如何支援替陣列做分頁機制</h1><span class="meta"><span>作者 狼 </span><span class="spliter">|</span> <span>日期 2024-08-17 </span><span class="spliter">|</span> <span id="busuanzi_container_page_pv"><i class="fa fa-eye"></i> <span id="busuanzi_value_page_pv"><i class="fa fa-spinner fa-spin"></i></span></span></span><div class="tags text-center"><a class="tag" href="/blog/tags/#Rails" title="Rails">Rails</a> <a class="tag" href="/blog/tags/#Ruby" title="Ruby">Ruby</a> <a class="tag" href="/blog/tags/#pagination" title="pagination">pagination</a></div></div></div></div></div><div class="post-title-haojen"><span>kaminari gem 分析，如何支援替陣列做分頁機制</span></div></header><article><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-1 col-sm-9 post-container"><h2 id="介紹"><a href="#介紹" class="headerlink" title="介紹"></a>介紹</h2><p>一般我們使用 kaminari 時，是為了想要替 ActiveRecord 做分頁，以避免一次性讀取所有資料。但有時候資料來源並非來自資料庫，例如當我們想顯示一個大型的 CSV 檔案時，行數過多需要分頁來優化顯示。此時我們會需要對一個陣列進行分頁。</p><p>其實，Kaminari 已經提供了一個 paginate_array 的 class method，讓我們可以對陣列進行分頁。這個方法會將陣列加上一些分頁相關的函式，讓它能夠配合分頁的 helper 函式 (pagination) 來 render 出分頁。</p><p>Ex:</p><pre><code class="rb">assets = Kaminari.paginate_array(array).page(params[:page]).per(params[:per])
paginate(assets)
</code></pre><h2 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h2><p>Kaminari 的<a target="_blank" rel="noopener" href="https://github.com/amatsuda/kaminari/blob/v1.1.1/kaminari-core/lib/kaminari/models/array_extension.rb">內部實作</a>較為複雜，我們來看看如果自己要實作一個支援分頁的陣列時，該怎麼做呢？</p><p>首先先觀察 source code 中 <a target="_blank" rel="noopener" href="https://github.com/amatsuda/kaminari/blob/v1.1.1/kaminari-core/lib/kaminari/helpers/helper_methods.rb#L21-L27">paginate</a> 函式的實作</p><blockquote><pre><code class="rb">def paginate(scope, paginator_class: Kaminari::Helpers::Paginator, template: nil, **options)
  options[:total_pages] ||= scope.total_pages
  options.reverse_merge! current_page: scope.current_page, per_page: scope.limit_value, remote: false

  paginator = paginator_class.new (template || self), options
  paginator.to_s
end
</code></pre></blockquote><p>這個函式主要會呼叫 scope 的三個方法：</p><ol><li><code>total_pages</code>: 總頁數</li><li><code>current_page</code>: 當前頁數</li><li><code>limit_value</code>: 每頁顯示的行數</li></ol><h3 id="定義屬性"><a href="#定義屬性" class="headerlink" title="定義屬性"></a>定義屬性</h3><p>首先，因為分頁需要上面三個方式，我們可以先定義好我們的陣列 class，並加上這幾個屬性：</p><pre><code class="rb">class ArrayWithPagination &lt; Array
  attr_accessor :current_page
  attr_accessor :total_pages
  attr_accessor :limit_value
end
</code></pre><p>接著，我們需要實作分頁機制、加上 <code>page</code> 與 <code>per</code> 這兩個函式。並在呼叫這二個函式的過程中，將上述三個屬性賦值為正確的數字。</p><h3 id="實作-page-函式"><a href="#實作-page-函式" class="headerlink" title="實作 page 函式"></a>實作 page 函式</h3><p>page 函式是用來設定當前頁數的。這邊可以單純先將資訊記錄在 instance variable (@page) 上，然後回傳自己，以利後續做 method chaining。</p><pre><code class="rb">class ArrayWithPagination &lt; Array
  def page(page_value)
    @page = page_value
    return self
  end
end
</code></pre><h3 id="實作-per-函式"><a href="#實作-per-函式" class="headerlink" title="實作 per 函式"></a>實作 per 函式</h3><p>per 函式是用來設定每頁顯示的行數的。我們需要計算並設定各屬性，並切割陣列，讓後續 render 時僅顯示當前頁面的資料。切割陣列時，我們要計算資料的起始位置 (start_idx) 與結束位置 (end_idx)。</p><p>當一頁有 N 筆資料時，第 1 頁的資料區間是 <code>0 ~ N-1</code>，第 2 頁的的資料區間是 <code>N ~ 2N - 1</code> 同理，第 K 頁的資料區間就是 <code>(K - 1) * N ~ (K - 1) * N + (N - 1)</code>。知道資料區間後，我們就知道該如何切割陣列。</p><p>Ex:</p><pre><code class="rb">class ArrayWithPagination &lt; Array
  def per(per_page)
    per_page = per_page.to_i
    start_idx = (@page ? @page.to_i - 1 : 0) * per_page
    end_idx = start_idx + per_page - 1

    ArrayWithPagination.new(self[start_idx...end_idx] || [])
  end
end
</code></pre><p>接著我們需要設定三個屬性</p><ol><li><code>current_page</code> 很簡單就設定為 page 函式中記錄的 instance variable (@page) 就好了</li><li><code>total_pages</code> 則可以用陣列長度 (size) 除以每頁筆數 (per_page) 來得到</li><li><code>limit_value</code> 也很簡單就是每頁筆數 (per_page)</li></ol><p>Ex:</p><pre><code class="rb">new_array.current_page = (@page || 1).to_i
new_array.total_pages = size / per_page
new_array.limit_value = per_page
</code></pre><h2 id="程式碼"><a href="#程式碼" class="headerlink" title="程式碼"></a>程式碼</h2><p>最終實作成程式如下：</p><pre><code class="rb">class ArrayWithPagination &lt; Array
  attr_accessor :current_page
  attr_accessor :total_pages
  attr_accessor :limit_value

  def page(page_value)
    @page = page_value
    return self
  end

  def per(per_page)
    per_page = per_page.to_i
    start_idx = (@page ? @page.to_i - 1 : 0) * per_page
    end_idx = start_idx + per_page - 1

    ArrayWithPagination.new(self[start_idx...end_idx] || []).tap do |new_array|
      new_array.current_page = (@page || 1).to_i
      new_array.total_pages = size / per_page
      new_array.limit_value = per_page
    end
  end
end
</code></pre><h2 id="後記"><a href="#後記" class="headerlink" title="後記"></a>後記</h2><p>這篇文章是記錄當時我在實作陣列分頁時的做法，後來發現其實 kaminari gem 內就有相關的實作了，特別用這邊文章留存一下當時實作的想法。</p><p>自己實作的版本好處在於較輕量，目前使用上雖然沒有遇到問題，但 gem 內的實作應該會考慮到更多的 edge case，未來比較不會踩雷。</p><hr><ul class="pager"><li class="previous"><a href="/blog/2024/05/18/當開發者遇上-MySQL-編碼：你知道你的-Rate-Limit-被巧妙繞過了嗎？/" data-toggle="tooltip" data-placement="top" title="當開發者遇上 MySQL 編碼：你知道你的 Rate Limit 被巧妙繞過了嗎？">&larr; Previous Post</a></li></ul><div class="comment"><div id="disqus_thread" class="disqus-thread"></div></div></div><div class="hidden-xs col-sm-3 toc-col"><div class="toc-wrap"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%B4%B9"><span class="toc-text">介紹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%A6%E4%BD%9C"><span class="toc-text">實作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E7%BE%A9%E5%B1%AC%E6%80%A7"><span class="toc-text">定義屬性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%A6%E4%BD%9C-page-%E5%87%BD%E5%BC%8F"><span class="toc-text">實作 page 函式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%A6%E4%BD%9C-per-%E5%87%BD%E5%BC%8F"><span class="toc-text">實作 per 函式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BC%8F%E7%A2%BC"><span class="toc-text">程式碼</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%8C%E8%A8%98"><span class="toc-text">後記</span></a></li></ol></div></div></div></div></article><script type="text/javascript">var disqus_shortname="khiav-blog-1",disqus_identifier="https://khiav223577.github.io/blog/2024/08/17/kaminari-gem-%E5%88%86%E6%9E%90%EF%BC%8C%E5%A6%82%E4%BD%95%E6%94%AF%E6%8F%B4%E6%9B%BF%E9%99%A3%E5%88%97%E5%81%9A%E5%88%86%E9%A0%81%E6%A9%9F%E5%88%B6/",disqus_url="https://khiav223577.github.io/blog/2024/08/17/kaminari-gem-%E5%88%86%E6%9E%90%EF%BC%8C%E5%A6%82%E4%BD%95%E6%94%AF%E6%8F%B4%E6%9B%BF%E9%99%A3%E5%88%97%E5%81%9A%E5%88%86%E9%A0%81%E6%A9%9F%E5%88%B6/";!function(){var E=document.createElement("script");E.type="text/javascript",E.async=!0,E.src="https://"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(E)}()</script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),c=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),c.parentNode.insertBefore(r,c)}</script><script>async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){anchors.options={visible:"hover",placement:"right"},anchors.add().remove(".intro-header h1").remove(".subheading").remove(".sidebar-container h5")})</script><style>@media all and (min-width:800px){.anchorjs-link{position:absolute;left:-.75em;font-size:1.1em;margin-top:-.1em}}</style><footer><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center"><br><div class="sidebar-container" style="padding:0"><div style="margin-top:20px"><h5 class="text-center">友情連結</h5><ul class="list-inline text-center"><li><a target="_blank" href="http://echo2010.weebly.com/">回音</a></li><li><a target="_blank" href="https://www.pagamo.org/">PaGamO</a></li><li><a target="_blank" href="https://www.pneko.com/">Pneko</a></li><li><a target="_blank" href="https://mobile-price.github.io/">手機即時查價</a></li></ul></div></div><ul class="list-inline text-center" style="margin-top:25px"><li><a target="_blank" href="https://www.facebook.com/khiav.reoy"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fab fa-facebook-f fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://github.com/khiav223577"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a target="_blank" href="https://www.linkedin.com/in/rumble-huang"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fab fa-linkedin-in fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 狼 2024<br><span><span id="busuanzi_container_site_pv"><i class="fa fa-eye" style="margin-right:3px" data-toggle="tooltip" title="本站總訪問量"></i> <span id="busuanzi_value_site_pv"><i class="fa fa-spinner fa-spin"></i></span> </span><span style="margin:0 5px">| </span><span id="busuanzi_container_site_uv"><i class="fa fa-user" style="margin-right:2px" data-toggle="tooltip" title="本站總訪客數"></i> <span id="busuanzi_value_site_uv"><i class="fa fa-spinner fa-spin"></i></span></span></span><br><br>Theme by <a target="_blank" href="https://haojen.github.io/">Haojen Ma</a></p></div></div></div></footer><script src="/blog/js/jquery.min.js"></script><script src="/blog/js/bootstrap.min.js"></script><script src="/blog/js/blog.js"></script><script>function async(e,n){var t=document,a="script",r=t.createElement(a),c=t.getElementsByTagName(a)[0];r.src=e,n&&r.addEventListener("load",function(e){n(null,e)},!1),c.parentNode.insertBefore(r,c)}</script><script>0!==$("#tag_cloud").length&&async("https://khiav223577.github.io/blog/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js",function(){var c=document.querySelector("nav");c&&FastClick.attach(c)})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LERHN3QS29"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-LERHN3QS29")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="/blog/js/run_prettify.js"></script><script>$(function(){$("pre > code[class]").addClass("prettyprint"),PR.prettyPrint()})</script><img class="wechat-title-img" src="/blog/imgs/wolf.jpg"></body></html>